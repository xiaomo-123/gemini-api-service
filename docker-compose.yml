services:
  gemini-api-service:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: gemini-api-service
    ports:
      - "3101:3101"
    environment:
      - PORT=3101
      - NODE_ENV=production
      - ALLOWED_ORIGINS=
      - PUPPETEER_SKIP_DOWNLOAD=true
      - PUPPETEER_EXECUTABLE_PATH=/usr/bin/chromium
      - DISABLE_IPV6=true
    volumes:
      - ./config:/app/config
      - ./logs:/app/logs    
    user: "10001:10001"
    privileged: true
    cap_add:
      - NET_ADMIN
      - SYS_ADMIN
    sysctls:
      - net.ipv6.conf.all.disable_ipv6=1
      - net.ipv6.conf.default.disable_ipv6=1
      - net.ipv6.conf.lo.disable_ipv6=1
      - net.ipv6.conf.eth0.disable_ipv6=1
    network_mode: "bridge"
    extra_hosts:
      - "host.docker.internal:host-gateway"     
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "3"    
    command: >
      sh -c "sysctl -w net.ipv6.conf.all.disable_ipv6=1 && sysctl -w net.ipv6.conf.default.disable_ipv6=1 && sysctl -w net.ipv6.conf.lo.disable_ipv6=1 && sysctl -w net.ipv6.conf.eth0.disable_ipv6=1 && mkdir -p /app/logs/uvicorn && touch /app/logs/uvicorn/access.log /app/logs/uvicorn/error.log /app/logs/combined.log /app/logs/error.log && chown -R appuser:appuser /app/logs && chmod -R 755 /app/logs && tail -f /app/logs/combined.log /app/logs/error.log > /proc/1/fd/1 2>/proc/1/fd/2 &"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://127.0.0.1:3101/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 15s
